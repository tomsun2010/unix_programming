/************************************
 * File name   : socket_server.c
 * Author      : SJC
 * Description : socket服务端

 * Date        : 2016-8-17 17:00:54
 * Modification:
 *
 * Makefile    : gcc -o server socket_server.c -lm
*****************************************************/

#include <stdio.h>  
#include <stdlib.h>
#include <string.h>
 
#include <netinet/in.h>
#include <sys/socket.h>
#include <signal.h> 
#include <unistd.h> 
#include <sys/types.h>  
  
int main(void)  
{  
    int server_sockfd = -1;  
    int server_len = 0;  
    int client_len = 0;  
    char buffer[512];  
    int result = 0; 
	
    struct sockaddr_in server_addr;  
    struct sockaddr_in client_addr;  
	
    //创建数据报套接字  
    server_sockfd = socket(AF_INET, SOCK_DGRAM, 0);
	
    //设置监听IP端口  
    server_addr.sin_family = AF_INET;  
    server_addr.sin_addr.s_addr = htonl(INADDR_ANY);  
    server_addr.sin_port = htons(9739);  
    server_len = sizeof(server_addr); 
	
    //绑定（命名）套接字  
    bind(server_sockfd, (struct sockaddr*)&server_addr, server_len);  
	
    //忽略子进程停止或退出信号  
    signal(SIGCHLD, SIG_IGN);  
  
  
    while(1)  
    {     
		printf("server waiting......\n");
        //接收数据，用client_addr来储存数据来源程序的IP端口  
        result = recvfrom(server_sockfd, buffer, sizeof(buffer), 0, (struct sockaddr*)&client_addr, &client_len);  
        if(fork() == 0)  
        {  
            //利用子进程来处理数据  
            buffer[0] += 'a' - 'A';  
            sleep(2); 
			
            //发送处理后的数据  
            sendto(server_sockfd, buffer, sizeof(buffer), 0, (struct sockaddr*)&client_addr, client_len);  
            printf("%c\n", buffer[0]);  
			
            //注意，一定要关闭子进程，否则程序运行会不正常   
            exit(0);  
        }  
    }  
    //关闭套接字  
    close(server_sockfd);  
	
	return 0;
}  